# Rudimentary viewer for mesh data positions and normals. On ubuntu with
# python3 isntalled, `sudo apt install python3-tk` for Tkinter. Breakpoint
# model generator and copy/paste JSON.stringify(meshData) from the debug
# console. Then python3 preview_mesh.py. Tweak transforms as needed.

import tkinter as tk
import json
import math

MESH_DATA_JSON = '{"positions":{"0":0,"1":-0.4000000059604645,"2":0,"3":0,"4":-0.4000000059604645,"5":-8.300000190734863,"6":-0.5,"7":-0.4000000059604645,"8":-8,"9":-0.5,"10":-0.4000000059604645,"11":8,"12":0,"13":-0.4000000059604645,"14":8.300000190734863,"15":0.5,"16":-0.4000000059604645,"17":8,"18":0.5,"19":-0.4000000059604645,"20":-8,"21":0.5,"22":-0.4000000059604645,"23":-8,"24":0.6499999761581421,"25":-8,"26":-10.399999618530273,"27":0,"28":-8,"29":-10.789999961853027,"30":0,"31":-0.4000000059604645,"32":-8.300000190734863,"33":0,"34":-0.4000000059604645,"35":-8.300000190734863,"36":0,"37":-8,"38":-10.789999961853027,"39":-0.6499999761581421,"40":-8,"41":-10.399999618530273,"42":-0.5,"43":-0.4000000059604645,"44":-8,"45":-0.5,"46":-0.4000000059604645,"47":-8,"48":-0.6499999761581421,"49":-8,"50":-10.399999618530273,"51":-0.6499999761581421,"52":-8,"53":10.399999618530273,"54":-0.5,"55":-0.4000000059604645,"56":8,"57":-0.5,"58":-0.4000000059604645,"59":8,"60":-0.6499999761581421,"61":-8,"62":10.399999618530273,"63":0,"64":-8,"65":10.789999961853027,"66":0,"67":-0.4000000059604645,"68":8.300000190734863,"69":0,"70":-0.4000000059604645,"71":8.300000190734863,"72":0,"73":-8,"74":10.789999961853027,"75":0.6499999761581421,"76":-8,"77":10.399999618530273,"78":0.5,"79":-0.4000000059604645,"80":8,"81":0.5,"82":-0.4000000059604645,"83":8,"84":0.6499999761581421,"85":-8,"86":10.399999618530273,"87":0.6499999761581421,"88":-8,"89":-10.399999618530273,"90":0.5,"91":-0.4000000059604645,"92":-8,"93":0,"94":-8,"95":0,"96":0,"97":-8,"98":-11.289999961853027,"99":-1.149999976158142,"100":-8,"101":-10.649999618530273,"102":-1.149999976158142,"103":-8,"104":10.649999618530273,"105":0,"106":-8,"107":11.289999961853027,"108":1.149999976158142,"109":-8,"110":10.649999618530273,"111":1.149999976158142,"112":-8,"113":-10.649999618530273,"114":1.149999976158142,"115":-8,"116":-10.649999618530273,"117":1.149999976158142,"118":-10,"119":-10.649999618530273,"120":0,"121":-10,"122":-11.289999961853027,"123":0,"124":-8,"125":-11.289999961853027,"126":0,"127":-8,"128":-11.289999961853027,"129":0,"130":-10,"131":-11.289999961853027,"132":-1.149999976158142,"133":-10,"134":-10.649999618530273,"135":-1.149999976158142,"136":-8,"137":-10.649999618530273,"138":-1.149999976158142,"139":-8,"140":-10.649999618530273,"141":-1.149999976158142,"142":-10,"143":-10.649999618530273,"144":-1.149999976158142,"145":-10,"146":10.649999618530273,"147":-1.149999976158142,"148":-8,"149":10.649999618530273,"150":-1.149999976158142,"151":-8,"152":10.649999618530273,"153":-1.149999976158142,"154":-10,"155":10.649999618530273,"156":0,"157":-10,"158":11.289999961853027,"159":0,"160":-8,"161":11.289999961853027,"162":0,"163":-8,"164":11.289999961853027,"165":0,"166":-10,"167":11.289999961853027,"168":1.149999976158142,"169":-10,"170":10.649999618530273,"171":1.149999976158142,"172":-8,"173":10.649999618530273,"174":1.149999976158142,"175":-8,"176":10.649999618530273,"177":1.149999976158142,"178":-10,"179":10.649999618530273,"180":1.149999976158142,"181":-10,"182":-10.649999618530273,"183":1.149999976158142,"184":-8,"185":-10.649999618530273},"normals":{"0":0,"1":1,"2":0,"3":0,"4":1,"5":0,"6":0,"7":1,"8":0,"9":0,"10":1,"11":0,"12":0,"13":1,"14":0,"15":0,"16":1,"17":0,"18":0,"19":1,"20":0,"21":0.49531984329223633,"22":0.270470529794693,"23":-0.8255325555801392,"24":0.49531984329223633,"25":0.270470529794693,"26":-0.8255325555801392,"27":0.49531984329223633,"28":0.270470529794693,"29":-0.8255325555801392,"30":0.49531984329223633,"31":0.270470529794693,"32":-0.8255325555801392,"33":-0.49531984329223633,"34":0.270470529794693,"35":-0.8255325555801392,"36":-0.49531984329223633,"37":0.270470529794693,"38":-0.8255325555801392,"39":-0.49531984329223633,"40":0.270470529794693,"41":-0.8255325555801392,"42":-0.49531984329223633,"43":0.270470529794693,"44":-0.8255325555801392,"45":-0.9998052716255188,"46":0.019732998684048653,"47":0,"48":-0.9998052716255188,"49":0.019732998684048653,"50":0,"51":-0.9998052716255188,"52":0.019732998684048653,"53":0,"54":-0.9998052716255188,"55":0.019732998684048653,"56":0,"57":-0.49531984329223633,"58":0.270470529794693,"59":0.8255325555801392,"60":-0.49531984329223633,"61":0.270470529794693,"62":0.8255325555801392,"63":-0.49531984329223633,"64":0.270470529794693,"65":0.8255325555801392,"66":-0.49531984329223633,"67":0.270470529794693,"68":0.8255325555801392,"69":0.49531984329223633,"70":0.270470529794693,"71":0.8255325555801392,"72":0.49531984329223633,"73":0.270470529794693,"74":0.8255325555801392,"75":0.49531984329223633,"76":0.270470529794693,"77":0.8255325555801392,"78":0.49531984329223633,"79":0.270470529794693,"80":0.8255325555801392,"81":0.9998052716255188,"82":0.019732998684048653,"83":0,"84":0.9998052716255188,"85":0.019732998684048653,"86":0,"87":0.9998052716255188,"88":0.019732998684048653,"89":0,"90":0.9998052716255188,"91":0.019732998684048653,"92":0,"93":0,"94":1,"95":0,"96":0,"97":1,"98":0,"99":0,"100":1,"101":0,"102":0,"103":1,"104":0,"105":0,"106":1,"107":0,"108":0,"109":1,"110":0,"111":0,"112":1,"113":0,"114":0.4862881302833557,"115":0,"116":-0.8737984895706177,"117":0.4862881302833557,"118":0,"119":-0.8737984895706177,"120":0.4862881302833557,"121":0,"122":-0.8737984895706177,"123":0.4862881302833557,"124":0,"125":-0.8737984895706177,"126":-0.4862881302833557,"127":0,"128":-0.8737984895706177,"129":-0.4862881302833557,"130":0,"131":-0.8737984895706177,"132":-0.4862881302833557,"133":0,"134":-0.8737984895706177,"135":-0.4862881302833557,"136":0,"137":-0.8737984895706177,"138":-1,"139":0,"140":0,"141":-1,"142":0,"143":0,"144":-1,"145":0,"146":0,"147":-1,"148":0,"149":0,"150":-0.4862881302833557,"151":0,"152":0.8737984895706177,"153":-0.4862881302833557,"154":0,"155":0.8737984895706177,"156":-0.4862881302833557,"157":0,"158":0.8737984895706177,"159":-0.4862881302833557,"160":0,"161":0.8737984895706177,"162":0.4862881302833557,"163":0,"164":0.8737984895706177,"165":0.4862881302833557,"166":0,"167":0.8737984895706177,"168":0.4862881302833557,"169":0,"170":0.8737984895706177,"171":0.4862881302833557,"172":0,"173":0.8737984895706177,"174":1,"175":0,"176":0,"177":1,"178":0,"179":0,"180":1,"181":0,"182":0,"183":1,"184":0,"185":0},"texCoords":{"0":0,"1":0,"2":0,"3":-8.300000190734863,"4":-0.5,"5":-8,"6":-0.5,"7":8,"8":0,"9":8.300000190734863,"10":0.5,"11":8,"12":0.5,"13":-8,"14":0,"15":-0.034952424466609955,"16":0,"17":-0.6990485191345215,"18":0,"19":-0.6990485191345215,"20":0,"21":-0.034952424466609955,"22":0,"23":-0.034952424466609955,"24":0,"25":-0.6990485191345215,"26":0,"27":-0.6990485191345215,"28":0,"29":-0.034952424466609955,"30":0,"31":-0.034952424466609955,"32":0,"33":-0.6990485191345215,"34":0,"35":-0.6990485191345215,"36":0,"37":-0.034952424466609955,"38":0,"39":-0.034952424466609955,"40":0,"41":-0.6990485191345215,"42":0,"43":-0.6990485191345215,"44":0,"45":-0.034952424466609955,"46":0,"47":-0.034952424466609955,"48":0,"49":-0.6990485191345215,"50":0,"51":-0.6990485191345215,"52":0,"53":-0.034952424466609955,"54":0,"55":-0.034952424466609955,"56":0,"57":-0.6990485191345215,"58":0,"59":-0.6990485191345215,"60":0,"61":-0.034952424466609955,"62":0,"63":0,"64":0,"65":-11.289999961853027,"66":-1.149999976158142,"67":-10.649999618530273,"68":-1.149999976158142,"69":10.649999618530273,"70":0,"71":11.289999961853027,"72":1.149999976158142,"73":10.649999618530273,"74":1.149999976158142,"75":-10.649999618530273,"76":0,"77":-0.501416802406311,"78":0,"79":-0.6267710328102112,"80":0,"81":-0.6267710328102112,"82":0,"83":-0.501416802406311,"84":0,"85":-0.501416802406311,"86":0,"87":-0.6267710328102112,"88":0,"89":-0.6267710328102112,"90":0,"91":-0.501416802406311,"92":0,"93":-0.501416802406311,"94":0,"95":-0.6267710328102112,"96":0,"97":-0.6267710328102112,"98":0,"99":-0.501416802406311,"100":0,"101":-0.501416802406311,"102":0,"103":-0.6267710328102112,"104":0,"105":-0.6267710328102112,"106":0,"107":-0.501416802406311,"108":0,"109":-0.501416802406311,"110":0,"111":-0.6267710328102112,"112":0,"113":-0.6267710328102112,"114":0,"115":-0.501416802406311,"116":0,"117":-0.501416802406311,"118":0,"119":-0.6267710328102112,"120":0,"121":-0.6267710328102112,"122":0,"123":-0.501416802406311},"indices":{"0":0,"1":6,"2":1,"3":0,"4":1,"5":2,"6":0,"7":2,"8":3,"9":0,"10":3,"11":4,"12":0,"13":4,"14":5,"15":0,"16":5,"17":6,"18":7,"19":9,"20":10,"21":9,"22":7,"23":8,"24":11,"25":13,"26":14,"27":13,"28":11,"29":12,"30":15,"31":17,"32":18,"33":17,"34":15,"35":16,"36":19,"37":21,"38":22,"39":21,"40":19,"41":20,"42":23,"43":25,"44":26,"45":25,"46":23,"47":24,"48":27,"49":29,"50":30,"51":29,"52":27,"53":28,"54":31,"55":37,"56":32,"57":31,"58":32,"59":33,"60":31,"61":33,"62":34,"63":31,"64":34,"65":35,"66":31,"67":35,"68":36,"69":31,"70":36,"71":37,"72":38,"73":40,"74":41,"75":40,"76":38,"77":39,"78":42,"79":44,"80":45,"81":44,"82":42,"83":43,"84":46,"85":48,"86":49,"87":48,"88":46,"89":47,"90":50,"91":52,"92":53,"93":52,"94":50,"95":51,"96":54,"97":56,"98":57,"99":56,"100":54,"101":55,"102":58,"103":60,"104":61,"105":60,"106":58,"107":59}}'
MESH_DATA = json.loads(MESH_DATA_JSON)


def toArray(d):
    a = []
    for i in range(len(d)):
        a.append(d[str(i)])
    return a


POSITIONS = toArray(MESH_DATA["positions"])


def getPosition(i):
    global POSITIONS
    p = i * 3
    return (POSITIONS[p], POSITIONS[p + 1], POSITIONS[p + 2], 1)


NORMALS = toArray(MESH_DATA["normals"])


def getNormal(i):
    global NORMALS
    p = i * 3
    return (NORMALS[p], NORMALS[p + 1], NORMALS[p + 2], 0)


INDICES = toArray(MESH_DATA["indices"])


def getTriangleIndices(i):
    global INDICES
    p = i * 3
    return (INDICES[p], INDICES[p + 1], INDICES[p + 2])


def vpx(x):
    return (x + 1) * 500


def vpy(y):
    return 1000 - (y + 1) * 500


def rotX(a):
    c = math.cos(a)
    s = math.sin(a)
    return [
        [1, 0, 0, 0],
        [0, c, -s, 0],
        [0, s, c, 0],
        [0, 0, 0, 1],
    ]


def rotY(a):
    c = math.cos(a)
    s = math.sin(a)
    return [
        [c, 0, s, 0],
        [0, 1, 0, 0],
        [-s, 0, c, 0],
        [0, 0, 0, 1],
    ]


def rotZ(a):
    c = math.cos(a)
    s = math.sin(a)
    return [
        [c, -s, 0, 0],
        [s, c, 0, 0],
        [0, 0, 1, 0],
        [0, 0, 0, 1],
    ]


def trans(dx, dy, dz):
    return [
        [1, 0, 0, dx],
        [0, 1, 0, dy],
        [0, 0, 1, dz],
        [0, 0, 0, 1],
    ]


def scale(x, y, z):
    return [
        [x, 0, 0, 0],
        [0, y, 0, 0],
        [0, 0, z, 0],
        [0, 0, 0, 1],
    ]


def uniformScale(s):
    return scale(s, s, s)


def rowDotCol(row, a, j):
    return row[0] * a[0][j] + row[1] * a[1][j] + row[2] * a[2][j] + row[3] * a[3][j]


def dot(a, b):
    return a[0] * b[0] + a[1] * b[1] + a[2] * b[2] + a[3] * b[3]


def mul(a, b):
    return [[rowDotCol(a[i], b, j) for j in range(4)] for i in range(4)]


def mulAll(l):
    a = l[0]
    for b in l[1:]:
        a = mul(a, b)
    return a


def mulVec(a, x):
    return (dot(a[0], x), dot(a[1], x), dot(a[2], x), dot(a[3], x))


def tx(x):
    return (x + 1) * 500


def ty(y):
    return 1000 - (y + 1) * 500


def ptsToArray(d):
    a = []
    for pt in d:
        a.append(pt["x"], pt["y"])
    return a


def vecAdd(a, b):
    return (a[0] + b[0], a[1] + b[1], a[2] + b[2], a[3] + b[3])


def as2d(p):
    return (p[0], p[1])


def draw_preview():
    global canvas, yAxisRotation

    r1 = rotY(math.pi * 2 * yAxisRotation)
    r2 = rotX(math.pi * 0.05)
    mx = scale(1, -1, 1)
    t = trans(12, 7, 0)
    s = uniformScale(40)
    m = mulAll([s, t, mx, r2, r1])

    for triangle in [getTriangleIndices(i) for i in range(len(INDICES) // 3)]:
        # triangle
        triangle2d = [as2d(mulVec(m, p)) for p in map(getPosition, triangle)]
        canvas.create_polygon(triangle2d, fill="", outline="black")
        # normal as arrow at vertex
        for i in range(3):
            position = mulVec(m, getPosition(triangle[i]))
            normal = mulVec(m, getNormal(triangle[i]))
            canvas.create_line(
                as2d(position),
                as2d(vecAdd(position, normal)),
                fill="blue",
                arrow=tk.LAST,
            )
        # axes
        org = as2d(mulVec(m, (0, 0, 0, 1)))
        xAxis = as2d(mulVec(m, (1, 0, 0, 1)))
        yAxis = as2d(mulVec(m, (0, 1, 0, 1)))
        zAxis = as2d(mulVec(m, (0, 0, 1, 1)))
        for tag, p in [("x", xAxis), ("y", yAxis), ("z", zAxis)]:
            canvas.create_line((org, p), fill="red")
            canvas.create_text(p, text=tag, fill="red")


def animate():
    global canvas, yAxisRotation
    yAxisRotation += 0.0025
    if yAxisRotation > 1:
        yAxisRotation -= 1
    canvas.delete("all")
    draw_preview()
    root.after(32, animate)


if __name__ == "__main__":
    root = tk.Tk()
    root.title("Mesh data preview")
    canvas = tk.Canvas(root, width=1000, height=1000, bg="white")
    canvas.pack()
    yAxisRotation = 0
    animate()
    # Start the Tkinter event loop
    root.mainloop()
