# Copyright (c) 2025-2026 Gene Ressler
# SPDX-License-Identifier: GPL-3.0-or-later

# Rudimentary viewer for buckled member mesh data. On ubuntu with
# python3 isntalled, `sudo apt install python3-tk` for Tkinter. Breakpoint
# model generator and copy/paste JSON.stringify(meshData) from the debug
# console. Then python3 preview_mesh.py. Tweak transforms as needed.

import tkinter as tk
import json
import math

MESH_DATA_JSON = '{"meshData":{"instanceModelTransforms":{"0":-0.19819946587085724,"1":-0.29746493697166443,"2":0,"3":0,"4":0.8872449994087219,"5":1.9837417602539062,"6":0,"7":0.3311469256877899,"8":0,"9":0,"10":0.800000011920929,"11":0,"12":0.10658880323171616,"13":7.920058727264404,"14":4,"15":1,"16":-0.19819946587085724,"17":-0.29746493697166443,"18":0,"19":0,"20":0.8872449994087219,"21":1.9837417602539062,"22":0,"23":0.3311469256877899,"24":0,"25":0,"26":0.800000011920929,"27":0,"28":0.10658880323171616,"29":7.920058727264404,"30":-4,"31":1,"32":-0.23007050156593323,"33":-0.2735616862773895,"34":0,"35":0,"36":0.8872308135032654,"37":1.9837523698806763,"38":0,"39":0.3311469256877899,"40":0,"41":0,"42":0.800000011920929,"43":0,"44":0.33665931224823,"45":8.193620681762695,"46":4,"47":1,"48":-0.23007050156593323,"49":-0.2735616862773895,"50":0,"51":0,"52":0.8872308135032654,"53":1.9837523698806763,"54":0,"55":0.3311469256877899,"56":0,"57":0,"58":0.800000011920929,"59":0,"60":0.33665931224823,"61":8.193620681762695,"62":-4,"63":1,"64":-0.16558410227298737,"65":-0.3199315071105957,"66":0,"67":0,"68":0.879040002822876,"69":1.8841623067855835,"70":0,"71":0.31735238432884216,"72":0,"73":0,"74":0.800000011920929,"75":0,"76":-0.09161066263914108,"77":7.622593879699707,"78":4,"79":1,"80":-0.16558410227298737,"81":-0.3199315071105957,"82":0,"83":0,"84":0.879040002822876,"85":1.8841623067855835,"86":0,"87":0.31735238432884216,"88":0,"89":0,"90":0.800000011920929,"91":0,"92":-0.09161066263914108,"93":7.622593879699707,"94":-4,"95":1,"96":-0.260770708322525,"97":-0.24854154884815216,"98":0,"99":0,"100":0.8745618462562561,"101":1.87827467918396,"102":0,"103":0.31735238432884216,"104":0,"105":0,"106":0.800000011920929,"107":0,"108":0.5974300503730774,"109":8.442161560058594,"110":4,"111":1,"112":-0.260770708322525,"113":-0.24854154884815216,"114":0,"115":0,"116":0.8745618462562561,"117":1.87827467918396,"118":0,"119":0.31735238432884216,"120":0,"121":0,"122":0.800000011920929,"123":0,"124":0.5974300503730774,"125":8.442161560058594,"126":-4,"127":1,"128":-0.13275185227394104,"129":-0.34090492129325867,"130":0,"131":0,"132":0.8673800826072693,"133":1.71099054813385,"134":0,"135":0.29252663254737854,"136":0,"137":0,"138":0.800000011920929,"139":0,"140":-0.25719475746154785,"141":7.302662372589111,"142":4,"143":1,"144":-0.13275185227394104,"145":-0.34090492129325867,"146":0,"147":0,"148":0.8673800826072693,"149":1.71099054813385,"150":0,"151":0.29252663254737854,"152":0,"153":0,"154":0.800000011920929,"155":0,"156":-0.25719475746154785,"157":7.302662372589111,"158":-4,"159":1,"160":-0.2900981903076172,"161":-0.22289514541625977,"162":0,"163":0,"164":0.8468611836433411,"165":1.6837546825408936,"166":0,"167":0.29252663254737854,"168":0,"169":0,"170":0.800000011920929,"171":0,"172":0.8875282406806946,"173":8.665057182312012,"174":4,"175":1,"176":-0.2900981903076172,"177":-0.22289514541625977,"178":0,"179":0,"180":0.8468611836433411,"181":1.6837546825408936,"182":0,"183":0.29252663254737854,"184":0,"185":0,"186":0.800000011920929,"187":0,"188":0.8875282406806946,"189":8.665057182312012,"190":-4,"191":1,"192":-0.10018487274646759,"193":-0.36057814955711365,"194":0,"195":0,"196":0.8558029532432556,"197":1.499387264251709,"198":0,"199":0.2609984278678894,"200":0,"201":0,"202":0.800000011920929,"203":0,"204":-0.3899466097354889,"205":6.961757183074951,"206":4,"207":1,"208":-0.10018487274646759,"209":-0.36057814955711365,"210":0,"211":0,"212":0.8558029532432556,"213":1.499387264251709,"214":0,"215":0.2609984278678894,"216":0,"217":0,"218":0.800000011920929,"219":0,"220":-0.3899466097354889,"221":6.961757183074951,"222":-4,"223":1,"224":-0.3181034326553345,"225":-0.19713954627513885,"226":0,"227":0,"228":0.8046147227287292,"229":1.4312916994094849,"230":0,"231":0.2610003650188446,"232":0,"233":0,"234":0.800000011920929,"235":0,"236":1.2056316137313843,"237":8.862196922302246,"238":4,"239":1,"240":-0.3181034326553345,"241":-0.19713954627513885,"242":0,"243":0,"244":0.8046147227287292,"245":1.4312916994094849,"246":0,"247":0.2610003650188446,"248":0,"249":0,"250":0.800000011920929,"251":0,"252":1.2056316137313843,"253":8.862196922302246,"254":-4,"255":1,"256":-0.06821337342262268,"257":-0.3792969882488251,"258":0,"259":0,"260":0.8460432291030884,"261":1.2815526723861694,"262":0,"263":0.22709687054157257,"264":0,"265":0,"266":0.800000011920929,"267":0,"268":-0.4901314973831177,"269":6.601179122924805,"270":4,"271":1,"272":-0.06821337342262268,"273":-0.3792969882488251,"274":0,"275":0,"276":0.8460432291030884,"277":1.2815526723861694,"278":0,"279":0.22709687054157257,"280":0,"281":0,"282":0.800000011920929,"283":0,"284":-0.4901314973831177,"285":6.601179122924805,"286":-4,"287":1,"288":-0.34502506256103516,"289":-0.17168760299682617,"290":0,"291":0,"292":0.7506279945373535,"293":1.154457926750183,"294":0,"295":0.22709308564662933,"296":0,"297":0,"298":0.800000011920929,"299":0,"300":1.5506566762924194,"301":9.033884048461914,"302":4,"303":1,"304":-0.34502506256103516,"305":-0.17168760299682617,"306":0,"307":0,"308":0.7506279945373535,"309":1.154457926750183,"310":0,"311":0.22709308564662933,"312":0,"313":0,"314":0.800000011920929,"315":0,"316":1.5506566762924194,"317":9.033884048461914,"318":-4,"319":1,"320":-0.03698969632387161,"321":-0.3974432945251465,"322":0,"323":0,"324":0.8383800387382507,"325":1.0798883438110352,"326":0,"327":0.19412532448768616,"328":0,"329":0,"330":0.800000011920929,"331":0,"332":-0.558344841003418,"333":6.221882343292236,"334":4,"335":1,"336":-0.03698969632387161,"337":-0.3974432945251465,"338":0,"339":0,"340":0.8383800387382507,"341":1.0798883438110352,"342":0,"343":0.19412532448768616,"344":0,"345":0,"346":0.800000011920929,"347":0,"348":-0.558344841003418,"349":6.221882343292236,"350":-4,"351":1,"352":-0.3711884617805481,"353":-0.14679422974586487,"354":0,"355":0,"356":0.6888692378997803,"357":0.8806805610656738,"358":0,"359":0.19412532448768616,"360":0,"361":0,"362":0.800000011920929,"363":0,"364":1.9218451976776123,"365":9.180678367614746,"366":4,"367":1,"368":-0.3711884617805481,"369":-0.14679422974586487,"370":0,"371":0,"372":0.6888692378997803,"373":0.8806805610656738,"374":0,"375":0.19412532448768616,"376":0,"377":0,"378":0.800000011920929,"379":0,"380":1.9218451976776123,"381":9.180678367614746,"382":-4,"383":1,"384":-0.0065236142836511135,"385":-0.4153480529785156,"386":0,"387":0,"388":0.8323238492012024,"389":0.9060773849487305,"390":0,"391":0.16407203674316406,"392":0,"393":0,"394":0.800000011920929,"395":0,"396":-0.595334529876709,"397":5.824438571929932,"398":4,"399":1,"400":-0.0065236142836511135,"401":-0.4153480529785156,"402":0,"403":0,"404":0.8323238492012024,"405":0.9060773849487305,"406":0,"407":0.16407203674316406,"408":0,"409":0,"410":0.800000011920929,"411":0,"412":-0.595334529876709,"413":5.824438571929932,"414":-4,"415":1,"416":-0.3969078063964844,"417":-0.12256050109863281,"418":0,"419":0,"420":0.6232370734214783,"421":0.6274411082267761,"422":0,"423":0.1640755981206894,"424":0,"425":0,"426":0.800000011920929,"427":0,"428":2.3187530040740967,"429":9.303238868713379,"430":4,"431":1,"432":-0.3969078063964844,"433":-0.12256050109863281,"434":0,"435":0,"436":0.6232370734214783,"437":0.6274411082267761,"438":0,"439":0.1640755981206894,"440":0,"441":0,"442":0.800000011920929,"443":0,"444":2.3187530040740967,"445":9.303238868713379,"446":-4,"447":1,"448":0.023265404626727104,"449":-0.43325674533843994,"450":0,"451":0,"452":0.8271792531013489,"453":0.7636197805404663,"454":0,"455":0.13782018423080444,"456":0,"457":0,"458":0.800000011920929,"459":0,"460":-0.6018581986427307,"461":5.409090518951416,"462":4,"463":1,"464":0.023265404626727104,"465":-0.43325674533843994,"466":0,"467":0,"468":0.8271792531013489,"469":0.7636197805404663,"470":0,"471":0.13782018423080444,"472":0,"473":0,"474":0.800000011920929,"475":0,"476":-0.6018581986427307,"477":5.409090518951416,"478":-4,"479":1,"480":-0.42244064807891846,"481":-0.09897689521312714,"482":0,"483":0,"484":0.5569367408752441,"485":0.40339741110801697,"486":0,"487":0.13781844079494476,"488":0,"489":0,"490":0.800000011920929,"491":0,"492":2.7411935329437256,"493":9.402215957641602,"494":4,"495":1,"496":-0.42244064807891846,"497":-0.09897689521312714,"498":0,"499":0,"500":0.5569367408752441,"501":0.40339741110801697,"502":0,"503":0.13781844079494476,"504":0,"505":0,"506":0.800000011920929,"507":0,"508":2.7411935329437256,"509":9.402215957641602,"510":-4,"511":1,"512":0.05249433219432831,"513":-0.45132291316986084,"514":0,"515":0,"516":0.8223481178283691,"517":0.6510023474693298,"518":0,"519":0.11550100892782211,"520":0,"521":0,"522":0.800000011920929,"523":0,"524":-0.5785927772521973,"525":4.975833892822266,"526":4,"527":1,"528":0.05249433219432831,"529":-0.45132291316986084,"530":0,"531":0,"532":0.8223481178283691,"533":0.6510023474693298,"534":0,"535":0.11550100892782211,"536":0,"537":0,"538":0.800000011920929,"539":0,"540":-0.5785927772521973,"541":4.975833892822266,"542":-4,"543":1,"544":-0.44796839356422424,"545":-0.07597584277391434,"546":0,"547":0,"548":0.49229785799980164,"549":0.21102935075759888,"550":0,"551":0.11550100892782211,"552":0,"553":0,"554":0.800000011920929,"555":0,"556":3.189162015914917,"557":9.478191375732422,"558":4,"559":1,"560":-0.44796839356422424,"561":-0.07597584277391434,"562":0,"563":0,"564":0.49229785799980164,"565":0.21102935075759888,"566":0,"567":0.11550100892782211,"568":0,"569":0,"570":0.800000011920929,"571":0,"572":3.189162015914917,"573":9.478191375732422,"574":-4,"575":1,"576":0.08128535747528076,"577":-0.46963000297546387,"578":0,"579":0,"580":0.8173800706863403,"581":0.5637801289558411,"582":0,"583":0.0966939628124237,"584":0,"585":0,"586":0.800000011920929,"587":0,"588":-0.5260984301567078,"589":4.524511337280273,"590":4,"591":1,"592":0.08128535747528076,"593":-0.46963000297546387,"594":0,"595":0,"596":0.8173800706863403,"597":0.5637801289558411,"598":0,"599":0.0966939628124237,"600":0,"601":0,"602":0.800000011920929,"603":0,"604":-0.5260984301567078,"605":4.524511337280273,"606":-4,"607":1,"608":-0.47360479831695557,"609":-0.05346255004405975,"610":0,"611":0,"612":0.43027377128601074,"613":0.047638412564992905,"614":0,"615":0.0966939628124237,"616":0,"617":0,"618":0.800000011920929,"619":0,"620":3.662766695022583,"621":9.531654357910156,"622":4,"623":1,"624":-0.47360479831695557,"625":-0.05346255004405975,"626":0,"627":0,"628":0.43027377128601074,"629":0.047638412564992905,"630":0,"631":0.0966939628124237,"632":0,"633":0,"634":0.800000011920929,"635":0,"636":3.662766695022583,"637":9.531654357910156,"638":-4,"639":1,"640":0.10974705219268799,"641":-0.48821091651916504,"642":0,"643":0,"644":0.8121645450592041,"645":0.4989034831523895,"646":0,"647":0.08128277212381363,"648":0,"649":0,"650":0.800000011920929,"651":0,"652":-0.444813072681427,"653":4.0548810958862305,"654":4,"655":1,"656":0.10974705219268799,"657":-0.48821091651916504,"658":0,"659":0,"660":0.8121645450592041,"661":0.4989034831523895,"662":0,"663":0.08128277212381363,"664":0,"665":0,"666":0.800000011920929,"667":0,"668":-0.444813072681427,"669":4.0548810958862305,"670":-4,"671":1,"672":-0.49941158294677734,"673":-0.0313417874276638,"674":0,"675":0,"676":0.3727303445339203,"677":-0.08700880408287048,"678":0,"679":0.08128277212381363,"680":0,"681":0,"682":0.800000011920929,"683":0,"684":4.1621785163879395,"685":9.562995910644531,"686":4,"687":1,"688":-0.49941158294677734,"689":-0.0313417874276638,"690":0,"691":0,"692":0.3727303445339203,"693":-0.08700880408287048,"694":0,"695":0.08128277212381363,"696":0,"697":0,"698":0.800000011920929,"699":0,"700":4.1621785163879395,"701":9.562995910644531,"702":-4,"703":1,"704":0.13796879351139069,"705":-0.5070669054985046,"706":0,"707":0,"708":0.806573748588562,"709":0.4511530101299286,"710":0,"711":0.06857766956090927,"712":0,"713":0,"714":0.800000011920929,"715":0,"716":-0.335066020488739,"717":3.5666701793670654,"718":4,"719":1,"720":0.13796879351139069,"721":-0.5070669054985046,"722":0,"723":0,"724":0.806573748588562,"725":0.4511530101299286,"726":0,"727":0.06857766956090927,"728":0,"729":0,"730":0.800000011920929,"731":0,"732":-0.335066020488739,"733":3.5666701793670654,"734":-4,"735":1,"736":-0.5254154205322266,"737":-0.0095286313444376,"738":0,"739":0,"740":0.3194253444671631,"741":-0.19837817549705505,"742":0,"743":0.06857766956090927,"744":0,"745":0,"746":0.800000011920929,"747":0,"748":4.687593936920166,"749":9.572525024414062,"750":4,"751":1,"752":-0.5254154205322266,"753":-0.0095286313444376,"754":0,"755":0,"756":0.3194253444671631,"757":-0.19837817549705505,"758":0,"759":0.06857766956090927,"760":0,"761":0,"762":0.800000011920929,"763":0,"764":4.687593936920166,"765":9.572525024414062,"766":-4,"767":1,"768":0.1660197526216507,"769":-0.5261817574501038,"770":0,"771":0,"772":0.8006183505058289,"773":0.416797399520874,"774":0,"775":0.058116111904382706,"776":0,"777":0,"778":0.800000011920929,"779":0,"780":-0.19709724187850952,"781":3.059603214263916,"782":4,"783":1,"784":0.1660197526216507,"785":-0.5261817574501038,"786":0,"787":0,"788":0.8006183505058289,"789":0.416797399520874,"790":0,"791":0.058116111904382706,"792":0,"793":0,"794":0.800000011920929,"795":0,"796":-0.19709724187850952,"797":3.059603214263916,"798":-4,"799":1,"800":-0.5516201853752136,"801":0.012047798372805119,"802":0,"803":0,"804":0.2703908681869507,"805":-0.2901725471019745,"806":0,"807":0.058116111904382706,"808":0,"809":0,"810":0.800000011920929,"811":0,"812":5.239213943481445,"813":9.560476303100586,"814":4,"815":1,"816":-0.5516201853752136,"817":0.012047798372805119,"818":0,"819":0,"820":0.2703908681869507,"821":-0.2901725471019745,"822":0,"823":0.058116111904382706,"824":0,"825":0,"826":0.800000011920929,"827":0,"828":5.239213943481445,"829":9.560476303100586,"830":-4,"831":1,"832":0.193952277302742,"833":-0.5455312132835388,"834":0,"835":0,"836":0.7943552732467651,"837":0.39276424050331116,"838":0,"839":0.04949222505092621,"840":0,"841":0,"842":0.800000011920929,"843":0,"844":-0.031077498570084572,"845":2.533421516418457,"846":4,"847":1,"848":0.193952277302742,"849":-0.5455312132835388,"850":0,"851":0,"852":0.7943552732467651,"853":0.39276424050331116,"854":0,"855":0.04949222505092621,"856":0,"857":0,"858":0.800000011920929,"859":0,"860":-0.031077498570084572,"861":2.533421516418457,"862":-4,"863":1,"864":-0.5780162811279297,"865":0.03344584256410599,"866":0,"867":0,"868":0.2254745215177536,"869":-0.3657434284687042,"870":0,"871":0.04949222505092621,"872":0,"873":0,"874":0.800000011920929,"875":0,"876":5.817230224609375,"877":9.527030944824219,"878":4,"879":1,"880":-0.5780162811279297,"881":0.03344584256410599,"882":0,"883":0,"884":0.2254745215177536,"885":-0.3657434284687042,"886":0,"887":0.04949222505092621,"888":0,"889":0,"890":0.800000011920929,"891":0,"892":5.817230224609375,"893":9.527030944824219,"894":-4,"895":1,"896":0.22180454432964325,"897":-0.5650880932807922,"898":0,"899":0,"900":0.7878609299659729,"901":0.3766047954559326,"902":0,"903":0.04236442595720291,"904":0,"905":0,"906":0.800000011920929,"907":0,"908":0.16287477314472198,"909":1.987890362739563,"910":4,"911":1,"912":0.22180454432964325,"913":-0.5650880932807922,"914":0,"915":0,"916":0.7878609299659729,"917":0.3766047954559326,"918":0,"919":0.04236442595720291,"920":0,"921":0,"922":0.800000011920929,"923":0,"924":0.16287477314472198,"925":1.987890362739563,"926":-4,"927":1,"928":-0.6045898795127869,"929":0.05470762029290199,"930":0,"931":0,"932":0.18442633748054504,"933":-0.427974671125412,"934":0,"935":0.04236442595720291,"936":0,"937":0,"938":0.800000011920929,"939":0,"940":6.421820163726807,"941":9.472323417663574,"942":4,"943":1,"944":-0.6045898795127869,"945":0.05470762029290199,"946":0,"947":0,"948":0.18442633748054504,"949":-0.427974671125412,"950":0,"951":0.04236442595720291,"952":0,"953":0,"954":0.800000011920929,"955":0,"956":6.421820163726807,"957":9.472323417663574,"958":-4,"959":1,"960":0.24960443377494812,"961":-0.584825873374939,"962":0,"963":0,"964":0.7812153697013855,"965":0.366405189037323,"966":0,"967":0.03645186871290207,"968":0,"969":0,"970":0.800000011920929,"971":0,"972":0.38467931747436523,"973":1.422802209854126,"974":4,"975":1,"976":0.24960443377494812,"977":-0.584825873374939,"978":0,"979":0,"980":0.7812153697013855,"981":0.366405189037323,"982":0,"983":0.03645186871290207,"984":0,"985":0,"986":0.800000011920929,"987":0,"988":0.38467931747436523,"989":1.422802209854126,"990":-4,"991":1,"992":-0.6313220858573914,"993":0.07586899399757385,"994":0,"995":0,"996":0.14694705605506897,"997":-0.4792858362197876,"998":0,"999":0.03645186871290207,"1000":0,"1001":0,"1002":0.800000011920929,"1003":0,"1004":7.053142547607422,"1005":9.396453857421875,"1006":4,"1007":1,"1008":-0.6313220858573914,"1009":0.07586899399757385,"1010":0,"1011":0,"1012":0.14694705605506897,"1013":-0.4792858362197876,"1014":0,"1015":0.03645186871290207,"1016":0,"1017":0,"1018":0.800000011920929,"1019":0,"1020":7.053142547607422,"1021":9.396453857421875,"1022":-4,"1023":1},"positions":{"0":1,"1":1,"2":0.5,"3":0,"4":1,"5":0.5,"6":0,"7":0,"8":0.5,"9":1,"10":0,"11":0.5,"12":1,"13":1,"14":-0.5,"15":1,"16":0,"17":-0.5,"18":0,"19":0,"20":-0.5,"21":0,"22":1,"23":-0.5,"24":1,"25":1,"26":0.5,"27":0,"28":1,"29":-0.5,"30":0,"31":1,"32":0.5,"33":1,"34":1,"35":-0.5,"36":0,"37":0,"38":0.5,"39":0,"40":0,"41":-0.5,"42":1,"43":0,"44":-0.5,"45":1,"46":0,"47":0.5},"normalIndices":{"0":0,"1":0,"2":0,"3":0,"4":1,"5":1,"6":1,"7":1,"8":2,"9":3,"10":3,"11":2,"12":5,"13":5,"14":4,"15":4},"indices":{"0":0,"1":1,"2":2,"3":0,"4":2,"5":3,"6":4,"7":5,"8":6,"9":4,"10":6,"11":7,"12":8,"13":9,"14":10,"15":8,"16":11,"17":9,"18":12,"19":13,"20":14,"21":12,"22":14,"23":15}},"members":[{"a":{"index":0},"b":{"index":1},"materialSizeMm":800,"length":14}],"jointLocations":{"0":1,"1":1,"2":7,"3":9},"trussCenterlineOffset":4}'

BUCKLED_MEMBER_MESH_DATA = json.loads(MESH_DATA_JSON)
MESH_DATA = BUCKLED_MEMBER_MESH_DATA["meshData"]


def toArray(d):
    a = []
    for i in range(len(d)):
        a.append(d[str(i)])
    return a


POSITIONS = toArray(MESH_DATA["positions"])


def getPosition(i):
    global POSITIONS
    p = i * 3
    return (POSITIONS[p], POSITIONS[p + 1], POSITIONS[p + 2], 1)


NORMAL_INDICES = toArray(MESH_DATA["normalIndices"])
CANONICAL_POINTS = [
    [0, 0, 0, 1],
    [1, 0, 0, 1],
    [1, 1, 0, 1],
    [0, 1, 0, 1],
]


def getNormal(i, sm):
    global NORMAL_INDICES, CANONICAL_POINTS
    ni = NORMAL_INDICES[i]
    if ni == 0:
        return (0, 0, 1, 0)
    if ni == 1:
        return (0, 0, -1, 0)
    p = [mulVec(sm, x) for x in CANONICAL_POINTS]
    
    n0x = p[0][0] / p[0][3] - p[3][0] / p[3][3]
    n0y = p[0][1] / p[0][3] - p[3][1] / p[3][3]
    n1x = p[1][0] / p[1][3] - p[2][0] / p[2][3]
    n1y = p[1][1] / p[1][3] - p[2][1] / p[2][3]
    if ni == 5:
        return [n0x, n0y, 0, 0]
    if ni == 4:
        return [n1x, n1y, 0, 0]
    if ni == 3:
        return [-n0x, -n0y, 0, 0]
    if ni == 2:
        return [-n1x, -n1y, 0, 0]


def arrayToMatrix(a):
    return [
        [a[0], a[4], a[8], a[12]],
        [a[1], a[5], a[9], a[13]],
        [a[2], a[6], a[10], a[14]],
        [a[3], a[7], a[11], a[15]],
    ]


SEGMENT_TRANSFORMS_ARRAY = toArray(MESH_DATA["instanceModelTransforms"])
SEGMENT_TRANSFORMS_MATRICES = [
    arrayToMatrix(SEGMENT_TRANSFORMS_ARRAY[i : i + 16])
    for i in range(0, len(SEGMENT_TRANSFORMS_ARRAY), 16)
]

INDICES = toArray(MESH_DATA["indices"])


def getTriangleIndices(i):
    global INDICES
    p = i * 3
    return (INDICES[p], INDICES[p + 1], INDICES[p + 2])


def rotX(a):
    c = math.cos(a)
    s = math.sin(a)
    return [
        [1, 0, 0, 0],
        [0, c, -s, 0],
        [0, s, c, 0],
        [0, 0, 0, 1],
    ]


def rotY(a):
    c = math.cos(a)
    s = math.sin(a)
    return [
        [c, 0, s, 0],
        [0, 1, 0, 0],
        [-s, 0, c, 0],
        [0, 0, 0, 1],
    ]


def rotZ(a):
    c = math.cos(a)
    s = math.sin(a)
    return [
        [c, -s, 0, 0],
        [s, c, 0, 0],
        [0, 0, 1, 0],
        [0, 0, 0, 1],
    ]


def trans(dx, dy, dz):
    return [
        [1, 0, 0, dx],
        [0, 1, 0, dy],
        [0, 0, 1, dz],
        [0, 0, 0, 1],
    ]


def scale(x, y, z):
    return [
        [x, 0, 0, 0],
        [0, y, 0, 0],
        [0, 0, z, 0],
        [0, 0, 0, 1],
    ]


def uniformScale(s):
    return scale(s, s, s)


def rowDotCol(row, a, j):
    return row[0] * a[0][j] + row[1] * a[1][j] + row[2] * a[2][j] + row[3] * a[3][j]


def dot(a, b):
    return a[0] * b[0] + a[1] * b[1] + a[2] * b[2] + a[3] * b[3]


def mul(a, b):
    return [[rowDotCol(a[i], b, j) for j in range(4)] for i in range(4)]


def mulAll(l):
    a = l[0]
    for b in l[1:]:
        a = mul(a, b)
    return a


def mulVec(a, x):
    return (dot(a[0], x), dot(a[1], x), dot(a[2], x), dot(a[3], x))


def mulSegment(a, x):
    p = mulVec(a, x)
    return (p[0] / p[3], p[1] / p[3], p[2], 1)


def ptsToArray(d):
    a = []
    for pt in d:
        a.append(pt["x"], pt["y"])
    return a


def vecAdd(a, b):
    return (a[0] + b[0], a[1] + b[1], a[2] + b[2], a[3] + b[3])


def as2d(p):
    return (p[0], p[1])


def getBoundingBox():
    xMin = yMin = zMin = 1e6
    xMax = yMax = zMax = -1e6

    for segMatrix in SEGMENT_TRANSFORMS_MATRICES:
        positions = [mulSegment(segMatrix, x) for x in CANONICAL_POINTS]
        for p in positions:
            px = p[0]
            py = p[1]
            pz = p[2]
            if px < xMin:
                xMin = px
            if px > xMax:
                xMax = px
            if py < yMin:
                yMin = py
            if py > yMax:
                yMax = py
            if pz < zMin:
                zMin = pz
            if pz > zMax:
                zMax = pz
    return (xMin, xMax - xMin, yMin, yMax - yMin, zMin, zMax - zMin)


def draw_preview():
    global canvas, yAxisRotation

    mVpTrans = trans(500, 500, 0)
    mVpScale = scale(500, -500, 1)
    mR1 = rotY(math.pi * 2 * yAxisRotation)
    mR2 = rotX(math.pi * 0.05)
    xMin, width, yMin, height, zMin, depth = getBoundingBox()
    mScale = uniformScale(0.6 * min(2 / width, 2 / height, 2 / depth))
    mCenter = trans(-xMin - 0.5 * width, -yMin - 0.5 * height, -zMin - 0.5 * depth)
    m = mulAll([mVpTrans, mVpScale, mR1, mR2, mScale, mCenter])

    for segMatrix in SEGMENT_TRANSFORMS_MATRICES:
        for triangle in [getTriangleIndices(i) for i in range(len(INDICES) // 3)]:
            # triangle
            vertices = map(getPosition, triangle)
            segVertices = [mulSegment(segMatrix, v) for v in vertices]
            triangle2d = [as2d(mulVec(m, p)) for p in segVertices]
            canvas.create_polygon(triangle2d, fill="", outline="black")
            # normal as arrow at vertex
            for i in range(3):
                position = mulVec(m, segVertices[i])
                normal = mulVec(m, getNormal(triangle[i], segMatrix))
                canvas.create_line(
                    as2d(position),
                    as2d(vecAdd(position, normal)),
                    fill="blue",
                    arrow=tk.LAST,
                )
            # axes
            org = as2d(mulVec(m, (0, 0, 0, 1)))
            xAxis = as2d(mulVec(m, (1, 0, 0, 1)))
            yAxis = as2d(mulVec(m, (0, 1, 0, 1)))
            zAxis = as2d(mulVec(m, (0, 0, 1, 1)))
            for tag, p in [("x", xAxis), ("y", yAxis), ("z", zAxis)]:
                canvas.create_line((org, p), fill="red")
                canvas.create_text(p, text=tag, fill="red")


def animate():
    global canvas, yAxisRotation
    yAxisRotation += 0.0025
    if yAxisRotation > 1:
        yAxisRotation -= 1
    canvas.delete("all")
    draw_preview()
    root.after(32, animate)


if __name__ == "__main__":
    root = tk.Tk()
    root.title("Mesh data preview")
    canvas = tk.Canvas(root, width=1000, height=1000, bg="white")
    canvas.pack()
    yAxisRotation = 0
    animate()
    # Start the Tkinter event loop
    root.mainloop()
